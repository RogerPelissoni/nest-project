generator client {
  provider = "prisma-client"
  output   = "../prisma/generated"
}

datasource db {
  provider = "mysql"
}

model User {
  id                BigInt    @id @default(autoincrement())
  name              String
  email             String    @unique
  email_verified_at DateTime?
  password          String

  profile_id BigInt  @default(1)
  company_id BigInt?
  person_id  BigInt?

  // Auditable
  created_by BigInt?
  updated_by BigInt?
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  // Relations
  profile Profile  @relation(fields: [profile_id], references: [id])
  company Company? @relation(fields: [company_id], references: [id])
  person  Person?  @relation(fields: [person_id], references: [id])

  // Auditables - Relations
  createdBy    User?  @relation("UserCreatedBy", fields: [created_by], references: [id])
  createdUsers User[] @relation("UserCreatedBy")

  updatedBy    User?  @relation("UserUpdatedBy", fields: [updated_by], references: [id])
  updatedUsers User[] @relation("UserUpdatedBy")

  // External
  createdProfiles Profile[] @relation("ProfileCreatedBy")
  updatedProfiles Profile[] @relation("ProfileUpdatedBy")

  createdProfilePermissions ProfilePermission[] @relation("ProfilePermissionCreatedBy")
  updatedProfilePermissions ProfilePermission[] @relation("ProfilePermissionUpdatedBy")

  createdPersons Person[] @relation("PersonCreatedBy")
  updatedPersons Person[] @relation("PersonUpdatedBy")
}

model Resource {
  id        BigInt @id @default(autoincrement())
  name      String @db.VarChar(50)
  signature String @unique @db.VarChar(100)

  // Auditable 
  created_at         DateTime            @default(now())
  updated_at         DateTime            @default(now())
  profilePermissions ProfilePermission[]
}

model Profile {
  id             BigInt  @id @default(autoincrement())
  name           String
  ds_description String? @db.Text
  company_id     BigInt

  // Auditable
  created_by BigInt?
  updated_by BigInt?
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  // Relations
  company Company @relation(fields: [company_id], references: [id])

  // Auditables - Relations
  createdBy User? @relation("ProfileCreatedBy", fields: [created_by], references: [id])
  updatedBy User? @relation("ProfileUpdatedBy", fields: [updated_by], references: [id])

  users              User[]
  profilePermissions ProfilePermission[]
}

model ProfilePermission {
  id               BigInt @id @default(autoincrement())
  profile_id       BigInt
  resource_id      BigInt
  permission_level Int    @default(0)

  // Auditable
  created_by BigInt?
  updated_by BigInt?
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  // Relations
  profile  Profile  @relation(fields: [profile_id], references: [id])
  resource Resource @relation(fields: [resource_id], references: [id])

  // Auditables - Relations
  createdBy User? @relation("ProfilePermissionCreatedBy", fields: [created_by], references: [id])
  updatedBy User? @relation("ProfilePermissionUpdatedBy", fields: [updated_by], references: [id])

  @@map("profile_permission")
}

model Company {
  id         BigInt  @id @default(autoincrement())
  name       String
  tp_company String
  ds_email   String?
  ds_phone   String?
  ds_address String?

  // Auditable
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  users    User[]
  profiles Profile[]
}

enum PersonGender {
  F
  M
}

model Person {
  id                    BigInt        @id @default(autoincrement())
  name                  String        @db.VarChar(150)
  ds_document           String?       @db.VarChar(20)
  ds_email              String?       @db.VarChar(100)
  ds_phone              String?       @db.VarChar(20)
  da_birth              DateTime?     @db.Date()
  tp_gender             PersonGender?
  ds_address_street     String?       @db.VarChar(120)
  ds_address_number     String?       @db.VarChar(20)
  ds_address_complement String?       @db.VarChar(60)
  ds_address_district   String?       @db.VarChar(80)
  ds_address_city       String?       @db.VarChar(80)
  ds_address_state      String?       @db.VarChar(2)
  ds_address_zipcode    String?       @db.VarChar(10)
  fl_active             Boolean       @default(true)

  // Auditable
  created_by BigInt?
  updated_by BigInt?
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  // Auditables - Relations
  createdBy User? @relation("PersonCreatedBy", fields: [created_by], references: [id])
  updatedBy User? @relation("PersonUpdatedBy", fields: [updated_by], references: [id])

  users User[]
}
